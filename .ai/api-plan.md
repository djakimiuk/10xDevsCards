# REST API Plan

## 1. Resources

- **Flashcards** (Table: flashcards):

  - Represents individual flashcards with properties:
    - `id` (UUID, primary key)
    - `user_id` (UUID, foreign key linking to the user)
    - `front` (text, max 200 characters)
    - `back` (text, max 500 characters)
    - `source` (text, must be either 'AI' or 'MANUAL')
    - `created_at` and `updated_at` timestamps

- **GenerationRequests** (Table: generation_requests):

  - Represents requests for AI-based flashcard generation with properties:
    - `id` (UUID, primary key)
    - `user_id` (UUID, foreign key)
    - `source_text` (text, between 1000 and 10000 characters)
    - `status` (text, one of 'processing', 'completed', 'failed')
    - `created_at` and `updated_at`

- **AICandidateFlashcards** (Table: ai_candidate_flashcards):

  - Represents candidate flashcards generated by AI that await user review. Properties include:
    - `id` (UUID, primary key)
    - `request_id` (UUID, foreign key linking to a generation request)
    - `front` (text, max 200 characters)
    - `back` (text, max 500 characters)
    - `created_at`

- **Users**: Managed externally by Supabase Auth, referenced by `user_id` in other tables.

## 2. Endpoints

### 2.1. Flashcards Endpoints

- **GET /api/flashcards**

  - **Description:** Retrieves a paginated list of flashcards for the authenticated user.
  - **Query Parameters:**
    - `page` (default 1)
    - `limit` (default 10)
    - Optional filter: `source` (e.g., 'AI' or 'MANUAL')
  - **Response JSON:**
    ```json
    {
      "flashcards": [{ "id": "uuid", "front": "...", "back": "...", "source": "MANUAL", "created_at": "timestamp" }],
      "pagination": { "page": 1, "limit": 10, "total": 50 }
    }
    ```

- **POST /api/flashcards**

  - **Description:** Creates a new flashcard manually.
  - **Request JSON:**
    ```json
    {
      "front": "Question text (max 200 chars)",
      "back": "Answer text (max 500 chars)"
    }
    ```
  - **Response:** 201 Created with the flashcard details, or 400 Bad Request if validation fails.

- **GET /api/flashcards/{id}**

  - **Description:** Retrieves details for a specific flashcard.
  - **Response:** Flashcard details (200 OK) or 404 Not Found if the flashcard does not exist.

- **PUT /api/flashcards/{id}**

  - **Description:** Updates an existing flashcard.
  - **Request JSON:**
    ```json
    {
      "front": "Updated question",
      "back": "Updated answer"
    }
    ```
  - **Response:** 200 OK with the updated flashcard data, or relevant error codes.

- **DELETE /api/flashcards/{id}**
  - **Description:** Deletes a flashcard.
  - **Response:** 204 No Content on successful deletion, or 404 Not Found.

### 2.2. Generation Requests Endpoints

- **POST /api/generation-requests**

  - **Description:** Initiates a new AI flashcard generation request.
  - **Request JSON:**
    ```json
    {
      "source_text": "Text between 1000 and 10000 characters to generate flashcards."
    }
    ```
  - **Validations:** Ensures that `source_text` length is within the required range.
  - **Response:** 201 Created with generation request details, or 400 Bad Request on validation error.

- **GET /api/generation-requests**

  - **Description:** Lists all generation requests for the authenticated user.
  - **Response:** Paginated list of generation request objects.

- **GET /api/generation-requests/{id}**
  - **Description:** Retrieves the details and status of a specific generation request.
  - **Response:** Generation request details (200 OK) or 404 Not Found.

### 2.3. AI Candidate Flashcards Endpoints

- **GET /api/ai-candidates**

  - **Description:** Retrieves a list of AI-generated candidate flashcards awaiting review. Optionally filter by a specific generation request using a query parameter (e.g., `generationRequestId`).
  - **Response:** Array of candidate flashcard objects.

- **PUT /api/ai-candidates/{id}**

  - **Description:** Edits an AI candidate flashcard to correct or improve its content before final acceptance.
  - **Request JSON:**
    ```json
    {
      "front": "Edited front text (max 200 chars)",
      "back": "Edited back text (max 500 chars)"
    }
    ```
  - **Response:** 200 OK with the updated candidate flashcard, or appropriate error responses.

- **POST /api/ai-candidates/{id}/accept**

  - **Description:** Accepts an AI candidate, converting it into a regular flashcard in the user's collection.
  - **Response:** 201 Created with the new flashcard details; the candidate is removed from the pending list.

- **DELETE /api/ai-candidates/{id}**
  - **Description:** Rejects and deletes an AI candidate flashcard.
  - **Response:** 204 No Content on successful deletion.

## 3. Authentication and Authorization

- **Mechanism:** JWT-based authentication managed via Supabase Auth.
- **Approach:** All endpoints (except those under `/api/auth/*`) require a valid Bearer token in the `Authorization` header.
- **Role-Based Access:** Endpoints enforce that users can only access and modify their own data (e.g., checking that the `user_id` in flashcards or generation requests matches the authenticated user).
- **Security Measures:** Implement rate limiting, input validation, and error logging to prevent abuse and ensure data integrity.

## 4. Validation and Business Logic

- **Flashcards Validations:**

  - `front` must not exceed 200 characters.
  - `back` must not exceed 500 characters.
  - `source` must be either "AI" or "MANUAL".

- **Generation Request Validations:**

  - `source_text` must have a length between 1000 and 10000 characters.

- **Business Logic Mapping:**

  - AI candidate flashcards are generated as part of a generation request and require user review (acceptance, editing or rejection) before becoming regular flashcards.
  - Spaced repetition endpoints adjust review scheduling based on user ratings, integrated with third-party SRS algorithms.
  - Endpoints include pagination, filtering, and sorting to handle large data sets effectively.

- **Error Handling and Status Codes:**
  - 400 Bad Request for validation errors.
  - 401 Unauthorized when authentication fails.
  - 403 Forbidden for unauthorized access attempts.
  - 404 Not Found for missing resources.
  - 500 Internal Server Error for unexpected issues.

This comprehensive API plan aligns the data schema, business requirements, and tech stack (Astro, TypeScript, React, Tailwind, and Supabase) to deliver a robust flashcard generator with AI and spaced repetition capabilities.
