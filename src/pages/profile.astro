---
/// <reference types="astro/client" />
import Layout from "@/layouts/Layout.astro";
import { createServerSupabaseClient, getUser as getSupabaseUser } from "@/lib/supabase";
import { logger } from "@/lib/logger";
import type { User } from "@supabase/supabase-js";

// Disable SSR for this page as it needs to be dynamic
export const prerender = false;

let userData: User | null = null;

try {
  const supabase = createServerSupabaseClient({ cookies: Astro.cookies });

  // Get user data
  const { user, error: userError } = await getSupabaseUser(supabase);

  if (userError) {
    logger.error("Error getting user session for profile:", userError);
    return Astro.redirect("/auth/login");
  }

  if (!user) {
    return Astro.redirect("/auth/login");
  }

  userData = user;
} catch (error) {
  logger.error("Unexpected error in profile page:", error);
  return Astro.redirect("/auth/login");
}
---

<Layout title="Profil - 10xDevsCards">
  <main class="container max-w-4xl mx-auto p-6">
    <h1 class="text-4xl font-bold mb-8">Profil użytkownika</h1>
    {
      userData && (
        <div class="bg-card text-card-foreground shadow rounded-lg p-6">
          <div class="mb-4">
            <h2 class="text-xl font-semibold mb-2">Dane podstawowe</h2>
            <p>
              <strong>Email:</strong> {userData.email}
            </p>
            <p>
              <strong>ID:</strong> {userData.id}
            </p>
          </div>
        </div>
      )
    }
    {!userData && <p>Ładowanie danych profilu lub wystąpił błąd...</p>}
  </main>
</Layout>
